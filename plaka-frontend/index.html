<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Plaka Takip Sistemi</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --accent: #ec4899;
            --bg: #f9fafb;
            --card-bg: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --border: #e5e7eb;
            --error: #ef4444;
            --success: #10b981;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, #ec489955, #3b82f655, #ffffff);
            min-height: 100vh;
            color: var(--text);
        }

        .hidden { display: none !important; }

        .center-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .login-container {
            width: 850px;
            height: 520px;
            background: white;
            border-radius: 15px;
            display: flex;
            box-shadow: 0px 0px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .login-left {
            width: 40%;
            background: linear-gradient(135deg, #ff72b6, #6da9ff);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 30px;
        }

        .login-left h1 { font-size: 32px; margin-bottom: 10px; }
        .login-right { width: 60%; padding: 40px; }

        .tab-buttons {
            display: flex;
            justify-content: space-evenly;
            margin-bottom: 20px;
        }

        .tab-buttons button {
            width: 45%;
            padding: 10px;
            background: #eee;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
        }

        .tab-buttons button.active {
            background: #7ab8ff;
            color: white;
            font-weight: bold;
        }

        .form-box { display: none; }
        .form-box.active { display: block; }

        h2 { text-align: center; color: #444; margin-top: 0; }

        .login-input {
            width: 100%;
            padding: 12px;
            margin-top: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 15px;
        }

        .btn {
            border-radius: 999px;
            border: none;
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            color: white;
            width: 100%;
            margin-top: 20px;
        }

        .btn-primary:hover { filter: brightness(1.05); }

        .error-text {
            color: var(--error);
            text-align: center;
            margin-top: 10px;
            font-size: 13px;
        }

        .success-text {
            color: var(--success);
            text-align: center;
            margin-top: 10px;
            font-size: 13px;
        }

        .app-shell { min-height: 100vh; display: flex; }
        .app-shell.home-only .main { padding: 32px 40px; }

        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, #0f172a, #111827);
            color: white;
            padding: 20px 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .logo-badge {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            background: linear-gradient(135deg, var(--accent), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .side-text { font-size: 12px; color: #9ca3af; }

        .menu {
            margin-top: 18px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .menu-btn {
            border-radius: 10px;
            padding: 8px 10px;
            border: none;
            background: transparent;
            color: #e5e7eb;
            text-align: left;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .menu-btn span.icon {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            background: rgba(148,163,184,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .menu-btn.active { background: rgba(248,250,252,0.08); }
        .menu-btn.active span.icon { background: linear-gradient(135deg, var(--accent), var(--primary)); }
        .menu-btn:hover:not(.active) { background: rgba(15,23,42,0.7); }

        .sidebar-footer { margin-top: auto; font-size: 11px; color: #9ca3af; }

        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-danger { background: transparent; border: 1px solid var(--error); color: var(--error); }

        .main {
            flex: 1;
            padding: 20px 32px;
            background: linear-gradient(180deg, #f9fafb, #eff6ff);
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .topbar h2 { margin: 0; font-size: 20px; }
        .topbar small { color: var(--muted); }

        .pill {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(59,130,246,0.08);
            color: #1d4ed8;
        }

        .cards-row {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 16px;
            margin-bottom: 22px;
        }

        .nav-card {
            background: var(--card-bg);
            border-radius: 14px;
            padding: 14px 14px 16px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
        }

        .nav-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 35px rgba(15,23,42,0.18);
            border-color: rgba(236,72,153,0.4);
        }

        .nav-card.active {
            border-color: var(--primary);
            box-shadow: 0 16px 35px rgba(59, 130, 246, 0.25);
        }

        .nav-card-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
        .nav-card-desc { font-size: 12px; color: var(--muted); }

        .section {
            background: #ffffff;
            border-radius: 18px;
            padding: 18px 20px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 14px 40px rgba(148,163,184,0.18);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .section-header h3 { margin: 0; font-size: 17px; }
        .section-header p { margin: 0; font-size: 12px; color: var(--muted); }

        .section-grid {
            display: grid;
            grid-template-columns: minmax(0, 340px) minmax(0, 1fr);
            gap: 18px;
        }

        .section-subtitle { font-weight: 600; font-size: 14px; margin-bottom: 6px; }

        .field { margin-bottom: 12px; }
        .field label { font-weight: 600; font-size: 13px; display: block; margin-bottom: 6px; }
        .field input, .field select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 14px;
            font-family: inherit;
        }

        .field input[disabled] { background: #f3f4f6; color: #6b7280; }

        .table-wrapper {
            border-radius: 14px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            background: #f9fafb;
        }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead { background: #f3f4f6; }
        th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; text-align: left; }
        th { font-weight: 600; font-size: 12px; color: #6b7280; }
        tbody tr:nth-child(even) { background: #f9fafb; }
        tfoot td { font-weight: 600; background: #eef2ff; }

        .muted { color: var(--muted); }

        .search-tabs {
            display: inline-flex;
            border-radius: 999px;
            padding: 3px;
            background: #f3f4f6;
        }

        .search-tab {
            border: none;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            background: transparent;
            color: #6b7280;
        }

        .search-tab.active {
            background: #ffffff;
            color: #111827;
            box-shadow: 0 2px 6px rgba(148,163,184,0.5);
        }

        .report-panel {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: #f9fafb;
            margin-bottom: 12px;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 10px;
        }

        .report-grid.two { grid-template-columns: repeat(2, minmax(0, 1fr)); }

        .report-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .report-note {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        .badge {
            background: rgba(59,130,246,0.1);
            color: #1d4ed8;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 600;
        }

        .report-flex {
            display: grid;
            grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
            gap: 18px;
        }

        .text-right { text-align: right; }
        .row-active { background: rgba(59,130,246,0.08) !important; }
        .empty-hint { color: var(--muted); font-size: 12px; padding: 8px 10px; }

        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .main { padding: 16px; }
            .cards-row { grid-template-columns: 1fr; }
            .section-grid { grid-template-columns: 1fr; }
            .report-grid, .report-flex { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="login-page" class="center-screen">
    <div class="login-container">
        <div class="login-left">
            <h1>Plaka Takip Sistemi</h1>
            <p>Giriş yap veya hesap oluştur</p>
        </div>

        <div class="login-right">
            <div class="tab-buttons">
                <button id="btnLogin" class="active">Giriş Yap</button>
                <button id="btnSignup">Üye Ol</button>
            </div>

            <div id="loginForm" class="form-box active">
                <h2>Giriş Yap</h2>
                <input id="loginUser" class="login-input" type="text" placeholder="Kullanıcı Adı">
                <input id="loginPass" class="login-input" type="password" placeholder="Şifre">
                <button id="login-btn" type="button" class="btn btn-primary">Giriş Yap</button>
                <div id="loginError" class="error-text"></div>
            </div>

            <div id="signupForm" class="form-box">
                <h2>Hesap Oluştur</h2>
                <input id="signupUser" class="login-input" type="text" placeholder="Kullanıcı Adı">
                <input id="signupPass" class="login-input" type="password" placeholder="Şifre">
                <input id="signupPass2" class="login-input" type="password" placeholder="Şifre Tekrar">
                <button id="signup-btn" type="button" class="btn btn-primary">Üye Ol</button>
                <div id="signupError" class="error-text"></div>
                <div id="signupSuccess" class="success-text"></div>
            </div>
        </div>
    </div>
</div>

<div id="app" class="app-shell hidden home-only">
    <aside class="sidebar">
        <div>
            <div class="logo">
                <div class="logo-badge">P</div>
                <span>Plaka Takip</span>
            </div>
            <div class="side-text">Tur şirketi anlaşmalı araç girişlerini, satışları ve hak edişi yönetin.</div>

            <div class="menu">
                <button class="menu-btn" data-section="daily">
                    <span class="icon">G</span> Günlük Giriş
                </button>
                <button class="menu-btn" data-section="manage">
                    <span class="icon">Y</span> Firma / Plaka Yönetimi
                </button>
                <button class="menu-btn" data-section="search">
                    <span class="icon">A</span> Arama & Raporlama
                </button>
            </div>
        </div>

        <div class="sidebar-footer">
            <div>Giriş yapan: <span id="sidebar-user">-</span></div>
            <button id="logout-btn" class="btn btn-sm btn-outline" style="margin-top:6px;">Çıkış yap</button>
        </div>
    </aside>

<main class="main">
    <div class="topbar">
        <div>
            <h2 style="font-family: inherit;">Kontrol Paneli</h2>
            <small class="muted">Plaka girişleri, satışlar ve raporlar tek ekranda.</small>
        </div>
        <span class="pill">Backend: http://localhost:3000</span>
    </div>

    <section id="section-home" class="section">
        <div style="text-align: center; padding: 40px 0;">
            <h1 style="font-size: 2.5rem; color: var(--primary); font-family: inherit;">Hoş Geldiniz, <span id="welcome-user"></span>!</h1>
            <p class="muted" style="font-size: 1.1rem;">Lütfen yapmak istediğiniz işlemi aşağıdaki seçeneklerden seçin.</p>
            <div style="margin-top: 20px;">
                <button id="home-logout-btn" class="btn btn-outline">Çıkış yap</button>
            </div>
        </div>
        <div class="cards-row">
            <div class="nav-card" data-section="daily">
                <div class="nav-card-title">Günlük Giriş</div>
                <div class="nav-card-desc">Araç plakası ve satış tutarı kaydedin.</div>
            </div>
            <div class="nav-card" data-section="manage">
                <div class="nav-card-title">Yeni Firma / Plaka Kaydı</div>
                <div class="nav-card-desc">Sisteme yeni firma veya araç tanımlayın,tanımlı firma ve plakaları düzenleyin.</div>
            </div>
            <div class="nav-card" data-section="search">
                <div class="nav-card-title">Arama & Raporlama</div>
                <div class="nav-card-desc">Detaylı analiz ve grafiklere ulaşın.</div>
            </div>
        </div>
    </section>

    <section id="section-daily" class="section hidden">
        <div class="section-header">
            <div>
                <h3 style="font-family: inherit;">Günlük Giriş</h3>
                <p>Plaka, firma ve satış tutarını girerek günlük kayıt oluşturun.</p>
            </div>
            <span class="muted" style="font-size:11px;">Bugün: <span id="today-label"></span></span>
        </div>

        <div class="section-grid">
            <div>
                <div class="section-subtitle" style="font-family: inherit;">Yeni Kayıt</div>
                <div class="field">
                    <label for="daily-plate">Plaka</label>
                    <input id="daily-plate" type="text" placeholder="34ABC123" />
                </div>

                <div class="field">
                    <label for="daily-firm">Firma</label>
                    <select id="daily-firm">
                        <option value="">— Firma seçin —</option>
                    </select>
                </div>

                <div class="field">
                    <label for="daily-date">Kayıt Tarihi</label>
                    <input id="daily-date" type="date" />
                </div>

                <div class="field">
                    <label for="daily-amount">Alışveriş Tutarı (TL)</label>
                    <input id="daily-amount" type="number" step="0.01" min="0" placeholder="0,00" />
                </div>

                <div class="field">
                    <label for="daily-commission">Hak ediş (%25)</label>
                    <input id="daily-commission" type="text" disabled />
                </div>

                <button id="daily-save-btn" class="btn btn-primary" style="margin-top:10px; width: 100%;">Kaydet</button>
                <div id="daily-message" class="muted" style="font-size:12px; margin-top:8px;"></div>
            </div>

            <div>
                <div class="section-subtitle" style="font-family: inherit;">Seçili Tarihe Ait Kayıtlar</div>
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <input id="daily-filter-date" type="date" class="login-input" style="margin:0; max-width: 180px;" />
                    <button id="daily-refresh-btn" class="btn btn-sm btn-outline">Yenile</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Plaka</th>
                                <th>Firma</th>
                                <th>Satış (TL)</th>
                                <th>Hak ediş (TL)</th>
                                <th>İşlem</th>
                            </tr>
                        </thead>
                        <tbody id="daily-table-body"></tbody>
                        <tfoot style="background: #eef2ff; font-weight: bold;">
                            <tr>
                                <td colspan="4" style="text-align: right;">Günlük Net Ciro (Satış - Hak ediş):</td>
                                <td colspan="2" id="daily-net-ciro" style="color: var(--primary); font-size: 15px;">0,00 TL</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <section id="section-manage" class="section hidden">
        <div class="section-header">
            <h3 style="font-family: inherit;">Firma / Plaka Yönetimi</h3>
        </div>
        <div class="section-grid">
            <div>
                <div class="section-subtitle">Firma İşlemleri</div>
                <div class="field">
                    <label for="manage-firm-name">Firma Ekle</label>
                    <input id="manage-firm-name" type="text" placeholder="Firma Adı (Büyük Harfe Dönüşür)" style="text-transform: uppercase;" />
                </div>
                <button id="manage-add-firm-btn" class="btn btn-primary" style="width: 100%;">Firmayı Ekle</button>

                <div class="field" style="margin-top: 16px;">
                    <label for="manage-firm-delete">Firma Sil</label>
                    <input id="manage-firm-delete" type="text" placeholder="Firma Adı" style="text-transform: uppercase;" />
                </div>
                <button id="manage-delete-firm-btn" class="btn btn-outline" style="width: 100%; border-color: var(--error); color: var(--error);">Firmayı Sil</button>

                <hr style="margin: 20px 0;">

                <div class="section-subtitle">Plaka İşlemleri</div>
                <div class="field">
                    <label for="manage-firm-select">Plaka Ekle (Firma seç)</label>
                    <select id="manage-firm-select"></select>
                </div>
                <div class="field">
                    <label for="manage-plate-text">Plaka</label>
                    <input id="manage-plate-text" type="text" placeholder="34ABC123" />
                </div>
                <button id="manage-add-plate-btn" class="btn btn-primary" style="width: 100%;">Plakayı Ekle</button>

                <div class="field" style="margin-top: 16px;">
                    <label for="manage-plate-delete">Plaka Sil</label>
                    <input id="manage-plate-delete" type="text" placeholder="Plaka" />
                </div>
                <button id="manage-delete-plate-btn" class="btn btn-outline" style="width: 100%; border-color: var(--error); color: var(--error);">Plakayı Sil</button>
            </div>
            <div>
                <div class="section-subtitle">Mevcut Firmalar</div>
                <div class="table-wrapper" style="margin-bottom: 12px;">
                    <table>
                        <thead><tr><th>Firma</th><th class="text-right">İşlem</th></tr></thead>
                        <tbody id="manage-firm-list"></tbody>
                    </table>
                </div>

                <div class="section-subtitle">Seçili Firmaya Ait Plakalar</div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Plaka</th><th class="text-right">İşlem</th></tr></thead>
                        <tbody id="manage-plate-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <section id="section-search" class="section hidden">
        <div class="section-header">
            <h3 style="font-family: inherit;">Gelişmiş Raporlama</h3>
            <div class="search-tabs">
                <button class="search-tab active" data-search="plate">Plaka Bazlı</button>
                <button class="search-tab" data-search="firm">Firma Bazlı</button>
                <button class="search-tab" data-search="date">Tarih Bazlı</button>
            </div>
        </div>

        <div id="report-plate" class="report-panel">
            <div class="report-grid">
                <div class="field">
                    <label>Plaka</label>
                    <input id="report-plate-input" type="text" placeholder="34ABC123" />
                </div>
                <div class="field">
                    <label>Başlangıç Tarihi</label>
                    <input id="report-plate-start" type="date" />
                </div>
                <div class="field">
                    <label>Bitiş Tarihi</label>
                    <input id="report-plate-end" type="date" />
                </div>
            </div>
            <div class="report-actions" style="margin-bottom: 6px;">
                <div class="field" style="margin: 0; flex: 0 0 140px;">
                    <label>Gruplama</label>
                    <select id="report-plate-group">
                        <option value="gun">Günlük</option>
                        <option value="ay">Aylık</option>
                        <option value="yil">Yıllık</option>
                    </select>
                </div>
                <button id="report-plate-btn" class="btn btn-primary" style="width: 160px;">Rapor Getir</button>
                <span id="report-plate-note" class="report-note"></span>
            </div>
            <div class="report-flex">
                <div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Plaka</th>
                                    <th>Firma</th>
                                    <th>Satış</th>
                                    <th>Hak ediş</th>
                                </tr>
                            </thead>
                            <tbody id="report-plate-body"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <canvas id="plateChart"></canvas>
                </div>
            </div>
        </div>

        <div id="report-firm" class="report-panel hidden">
            <div class="report-grid">
                <div class="field">
                    <label>Firma</label>
                    <input id="report-firm-input" type="text" placeholder="FİRMA ADI" style="text-transform: uppercase;" />
                </div>
                <div class="field">
                    <label>Başlangıç Tarihi</label>
                    <input id="report-firm-start" type="date" />
                </div>
                <div class="field">
                    <label>Bitiş Tarihi</label>
                    <input id="report-firm-end" type="date" />
                </div>
            </div>
            <div class="report-actions" style="margin-bottom: 6px;">
                <div class="field" style="margin: 0; flex: 0 0 140px;">
                    <label>Gruplama</label>
                    <select id="report-firm-group">
                        <option value="gun">Günlük</option>
                        <option value="ay">Aylık</option>
                        <option value="yil">Yıllık</option>
                    </select>
                </div>
                <button id="report-firm-btn" class="btn btn-primary" style="width: 160px;">Rapor Getir</button>
                <span id="report-firm-note" class="report-note"></span>
            </div>
            <div class="report-flex">
                <div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Toplam Satış</th>
                                    <th>Toplam Hak ediş</th>
                                </tr>
                            </thead>
                            <tbody id="report-firm-body"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <canvas id="firmChart"></canvas>
                </div>
            </div>
        </div>

        <div id="report-date" class="report-panel hidden">
            <div class="report-grid two">
                <div class="field">
                    <label>Başlangıç Tarihi</label>
                    <input id="report-date-start" type="date" />
                </div>
                <div class="field">
                    <label>Bitiş Tarihi</label>
                    <input id="report-date-end" type="date" />
                </div>
            </div>
            <div class="report-actions" style="margin-bottom: 8px;">
                <button id="report-date-btn" class="btn btn-primary" style="width: 160px;">Rapor Getir</button>
                <span class="badge">Net Ciro: <span id="report-date-net">0,00 TL</span></span>
                <span id="report-date-note" class="report-note"></span>
            </div>

            <div class="report-flex">
                <div>
                    <h4 style="margin: 0 0 8px 0;">Firma Payları (Daire Grafik)</h4>
                    <canvas id="datePieChart"></canvas>
                </div>
                <div>
                    <h4 style="margin: 0 0 8px 0;">Aylık Net Ciro (Sütun Grafik)</h4>
                    <canvas id="dateBarChart"></canvas>
                </div>
            </div>

            <div class="report-flex" style="margin-top: 16px;">
                <div>
                    <div class="section-subtitle">Firma Bazlı Net Ciro</div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr><th>Firma</th><th>Net Ciro</th></tr>
                            </thead>
                            <tbody id="report-date-firm-body"></tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <div class="section-subtitle">Yıllık Net Ciro</div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr><th>Yıl</th><th>Net Ciro</th></tr>
                            </thead>
                            <tbody id="report-date-year-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
</div>

<script>
    const API_BASE = "https://plakatakipsitesi.onrender.com";
    let currentUser = null;
    let plateChart = null;
    let firmChart = null;
    let datePieChart = null;
    let dateBarChart = null;
    let selectedFirmId = null;

    const loginPage = document.getElementById("login-page");
    const appShell = document.getElementById("app");
    const sidebarUser = document.getElementById("sidebar-user");
    const loginError = document.getElementById("loginError");
    const signupError = document.getElementById("signupError");
    const signupSuccess = document.getElementById("signupSuccess");

    const formatCurrency = (value) => {
        const n = Number(value || 0);
        return n.toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " TL";
    };

    const todayStr = () => {
        const d = new Date();
        return d.toISOString().slice(0, 10);
    };

    const normalizePlateInput = (value) => {
        if (!value) return "";
        return value.toString().trim().toUpperCase().replace(/\s+/g, "");
    };

    const normalizeFirmInput = (value) => {
        if (!value) return "";
        return value.toString().trim().toUpperCase();
    };

    const fetchJson = async (url, options) => {
        const res = await fetch(url, options);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || "Hata oluştu");
        return data;
    };

    //giriş-üye ol sekme yönetimi
    function showTab(tab) {
        document.getElementById("btnLogin").classList.toggle("active", tab === "login");
        document.getElementById("btnSignup").classList.toggle("active", tab === "signup");
        document.getElementById("loginForm").classList.toggle("active", tab === "login");
        document.getElementById("signupForm").classList.toggle("active", tab === "signup");
        loginError.textContent = "";
        signupError.textContent = "";
        signupSuccess.textContent = "";
    }

    document.getElementById("btnLogin").onclick = () => showTab("login");
    document.getElementById("btnSignup").onclick = () => showTab("signup");

    //kullanıcı işlemleri
    async function signup() {
        const u = document.getElementById("signupUser").value.trim();
        const p = document.getElementById("signupPass").value.trim();
        const p2 = document.getElementById("signupPass2").value.trim();
        if (!u || !p) return alert("Eksik bilgi!");
        if (p !== p2) return (signupError.textContent = "Şifreler aynı değil");

        try {
            await fetchJson(`${API_BASE}/auth/register`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ kullanici_adi: u, sifre: p })
            });
            signupSuccess.textContent = "Kayıt başarılı!";
            setTimeout(() => showTab("login"), 900);
        } catch (err) {
            signupError.textContent = err.message;
        }
    }

    async function login() {
        const u = document.getElementById("loginUser").value.trim();
        const p = document.getElementById("loginPass").value.trim();

        try {
            const data = await fetchJson(`${API_BASE}/auth/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ kullanici_adi: u, sifre: p })
            });
            currentUser = data.user;
            sidebarUser.textContent = u;
            loginPage.classList.add("hidden");
            appShell.classList.remove("hidden");
            document.getElementById("welcome-user").textContent = u;
            switchSection("home");
            initApp();
        } catch (err) {
            loginError.textContent = err.message;
        }
    }

    function logout() {
        currentUser = null;
        loginPage.classList.remove("hidden");
        appShell.classList.add("hidden");
        showTab("login");
    }

    //uygulamayı başlatma
    document.getElementById("signup-btn").onclick = signup;
    document.getElementById("login-btn").onclick = login;
    document.getElementById("logout-btn").onclick = logout;
    document.getElementById("home-logout-btn").onclick = logout;

    async function initApp() {
        document.getElementById("today-label").textContent = new Date().toLocaleDateString("tr-TR");
        document.getElementById("daily-date").value = todayStr();
        document.getElementById("daily-filter-date").value = todayStr();
        await loadFirms();
        await loadPlates();
        await renderDailyTable();
        await renderManageTables();
        initReportDefaults();
    }

    //firma ve plaka verilerini yükleme
    async function loadFirms() {
        const firms = await fetchJson(`${API_BASE}/firmalar?kullanici_id=${currentUser.id}`);
        window.firmsList = firms;
        const selects = [document.getElementById("daily-firm"), document.getElementById("manage-firm-select")];
        selects.forEach(sel => {
            sel.innerHTML = '<option value="">Firma Seçin</option>';
            firms.forEach(f => sel.innerHTML += `<option value="${f.id}">${f.firma_adi}</option>`);
        });
    }

    async function loadPlates() {
        window.platesList = await fetchJson(`${API_BASE}/araclar?kullanici_id=${currentUser.id}`);
    }

    document.getElementById("manage-firm-name").addEventListener("input", (e) => {
        e.target.value = normalizeFirmInput(e.target.value);
    });
    document.getElementById("manage-firm-delete").addEventListener("input", (e) => {
        e.target.value = normalizeFirmInput(e.target.value);
    });
    document.getElementById("manage-plate-text").addEventListener("input", (e) => {
        e.target.value = normalizePlateInput(e.target.value);
    });
    document.getElementById("manage-plate-delete").addEventListener("input", (e) => {
        e.target.value = normalizePlateInput(e.target.value);
    });
    document.getElementById("daily-plate").addEventListener("input", (e) => {
        e.target.value = normalizePlateInput(e.target.value);
    });
    document.getElementById("report-plate-input").addEventListener("input", (e) => {
        e.target.value = normalizePlateInput(e.target.value);
    });
    document.getElementById("report-firm-input").addEventListener("input", (e) => {
        e.target.value = normalizeFirmInput(e.target.value);
    });

    document.getElementById("manage-add-firm-btn").onclick = async () => {
        const name = normalizeFirmInput(document.getElementById("manage-firm-name").value);
        if (!name) return alert("Firma adı gerekli");
        await fetchJson(`${API_BASE}/firmalar`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ firma_adi: name, kullanici_id: currentUser.id })
        });
        document.getElementById("manage-firm-name").value = "";
        alert("Firma eklendi!");
        initApp();
    };

    document.getElementById("manage-delete-firm-btn").onclick = async () => {
        const name = normalizeFirmInput(document.getElementById("manage-firm-delete").value);
        if (!name) return alert("Firma adı gerekli");
        await fetchJson(`${API_BASE}/firmalar/sil`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ firma_adi: name, kullanici_id: currentUser.id })
        });
        document.getElementById("manage-firm-delete").value = "";
        alert("Firma ve bağlı plakalar pasife alındı!");
        initApp();
    };

    document.getElementById("manage-add-plate-btn").onclick = async () => {
        const fId = document.getElementById("manage-firm-select").value;
        const plaka = normalizePlateInput(document.getElementById("manage-plate-text").value);
        if (!plaka || !fId) return alert("Firma ve plaka gerekli");
        await fetchJson(`${API_BASE}/araclar`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ plaka, firma_id: fId, kullanici_id: currentUser.id })
        });
        document.getElementById("manage-plate-text").value = "";
        alert("Plaka eklendi!");
        initApp();
    };

    document.getElementById("manage-delete-plate-btn").onclick = async () => {
        const plaka = normalizePlateInput(document.getElementById("manage-plate-delete").value);
        if (!plaka) return alert("Plaka gerekli");
        await fetchJson(`${API_BASE}/araclar/sil`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ plaka, kullanici_id: currentUser.id })
        });
        document.getElementById("manage-plate-delete").value = "";
        alert("Plaka pasife alındı!");
        initApp();
    };

    //günlük kayıtları hesaplama ve rapor etme
    document.getElementById("daily-amount").oninput = (e) => {
        const value = parseFloat(e.target.value || 0);
        document.getElementById("daily-commission").value = isNaN(value) ? "" : (value * 0.25).toFixed(2) + " TL";
    };

    document.getElementById("daily-save-btn").onclick = async () => {
        const plakaStr = normalizePlateInput(document.getElementById("daily-plate").value);
        const miktar = parseFloat(document.getElementById("daily-amount").value || 0);
        const fId = document.getElementById("daily-firm").value;
        const tarih = document.getElementById("daily-date").value || todayStr();
        const message = document.getElementById("daily-message");

        if (!plakaStr) return (message.textContent = "Plaka gerekli");
        if (!miktar || miktar <= 0) return (message.textContent = "Satış 0'dan büyük olmalı");

        let plate = window.platesList.find(p => p.plaka === plakaStr);
        if (!plate) {
            if (!fId) return (message.textContent = "Yeni plaka için firma seçin");
            const pData = await fetchJson(`${API_BASE}/araclar`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ plaka: plakaStr, firma_id: fId, kullanici_id: currentUser.id })
            });
            plate = { id: pData.id, plaka: plakaStr };
        }

        await fetchJson(`${API_BASE}/kayitlar`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ arac_id: plate.id, kullanici_id: currentUser.id, satis_miktari: miktar, tarih })
        });

        document.getElementById("daily-plate").value = "";
        document.getElementById("daily-amount").value = "";
        document.getElementById("daily-commission").value = "";
        message.textContent = "Kayıt eklendi.";
        await loadPlates();
        document.getElementById("daily-filter-date").value = tarih;
        renderDailyTable();
    };

    document.getElementById("daily-refresh-btn").onclick = renderDailyTable;
    document.getElementById("daily-filter-date").addEventListener("change", renderDailyTable);

    async function renderDailyTable() {
        const selected = document.getElementById("daily-filter-date").value || todayStr();
        const data = await fetchJson(`${API_BASE}/kayitlar?baslangic=${selected}&bitis=${selected}&kullanici_id=${currentUser.id}`);
        let toplamSatis = 0;
        let toplamHakedis = 0;

        document.getElementById("daily-table-body").innerHTML = data.map(r => {
            toplamSatis += Number(r.satis_miktari || 0);
            toplamHakedis += Number(r.hakedis || 0);
            return `<tr data-id="${r.id}">
                <td>${r.tarih}</td>
                <td>${r.plaka}</td>
                <td>${r.firma_adi || '-'}</td>
                <td>${formatCurrency(r.satis_miktari)}</td>
                <td>${formatCurrency(r.hakedis)}</td>
                <td><button class="btn btn-sm btn-danger" data-action="delete">Sil</button></td>
            </tr>`;
        }).join("");

        const net = toplamSatis - toplamHakedis;
        document.getElementById("daily-net-ciro").textContent = formatCurrency(net);
    }

    document.getElementById("daily-table-body").addEventListener("click", async (event) => {
        const btn = event.target.closest("button[data-action='delete']");
        if (!btn) return;
        const row = event.target.closest("tr");
        const id = row?.dataset?.id;
        if (!id) return;
        const ok = confirm("Bu kaydı silmek istediğinize emin misiniz?");
        if (!ok) return;
        await fetchJson(`${API_BASE}/kayitlar/sil`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, kullanici_id: currentUser.id })
        });
        renderDailyTable();
    });

    //yönetim tabloları render etme
    async function renderManageTables() {
        const firms = window.firmsList || [];
        const plates = window.platesList || [];

        document.getElementById("manage-firm-list").innerHTML = firms.map(f => {
            const active = f.id === selectedFirmId ? "row-active" : "";
            return `<tr data-firm-id="${f.id}" class="${active}">
                <td>${f.firma_adi}</td>
                <td class="text-right"><button class="btn btn-sm btn-danger" data-action="delete-firm">Sil</button></td>
            </tr>`;
        }).join("");

        if (!selectedFirmId) {
            document.getElementById("manage-plate-list").innerHTML = `<tr><td colspan="2" class="empty-hint">Plaka listesini görmek için bir firma seçin.</td></tr>`;
            return;
        }

        const firmPlates = plates.filter(p => p.firma_id === selectedFirmId);
        document.getElementById("manage-plate-list").innerHTML = firmPlates.map(p => `
            <tr data-plate="${p.plaka}" data-plate-id="${p.id}">
                <td>${p.plaka}</td>
                <td class="text-right"><button class="btn btn-sm btn-danger" data-action="delete-plate">Sil</button></td>
            </tr>
        `).join("");
    }

    document.getElementById("manage-firm-list").addEventListener("click", async (event) => {
        const row = event.target.closest("tr[data-firm-id]");
        if (!row) return;

        const firmId = Number(row.dataset.firmId);
        const actionBtn = event.target.closest("button[data-action='delete-firm']");

        if (actionBtn) {
            const firm = (window.firmsList || []).find(f => f.id === firmId);
            if (!firm) return;
            const ok = confirm(`${firm.firma_adi} firmasını silmek istiyor musunuz?`);
            if (!ok) return;
            await fetchJson(`${API_BASE}/firmalar/sil`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ firma_id: firm.id, firma_adi: firm.firma_adi, kullanici_id: currentUser.id })
            });
            if (selectedFirmId === firmId) selectedFirmId = null;
            await loadFirms();
            await loadPlates();
            renderManageTables();
            return;
        }

        selectedFirmId = firmId;
        renderManageTables();
    });

    document.getElementById("manage-plate-list").addEventListener("click", async (event) => {
        const btn = event.target.closest("button[data-action='delete-plate']");
        if (!btn) return;
        const row = event.target.closest("tr[data-plate]");
        if (!row) return;
        const plaka = row.dataset.plate;
        const plateId = row.dataset.plateId;
        const ok = confirm(`${plaka} plakasını silmek istiyor musunuz?`);
        if (!ok) return;
        await fetchJson(`${API_BASE}/araclar/sil`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ arac_id: plateId, plaka, kullanici_id: currentUser.id })
        });
        await loadPlates();
        renderManageTables();
    });

    function destroyChart(ref) {
        if (ref) ref.destroy();
        return null;
    }
    
    function showReportTab(tabKey) {
        document.querySelectorAll(".search-tab").forEach(btn => btn.classList.remove("active"));
        document.querySelector(`.search-tab[data-search="${tabKey}"]`).classList.add("active");

        document.getElementById("report-plate").classList.toggle("hidden", tabKey !== "plate");
        document.getElementById("report-firm").classList.toggle("hidden", tabKey !== "firm");
        document.getElementById("report-date").classList.toggle("hidden", tabKey !== "date");
    }

    document.querySelectorAll(".search-tab").forEach(btn => {
        btn.onclick = () => showReportTab(btn.dataset.search);
    });

    function initReportDefaults() {
        const today = todayStr();
        const start = new Date();
        start.setDate(start.getDate() - 7);
        const startStr = start.toISOString().slice(0, 10);

        document.getElementById("report-plate-start").value = startStr;
        document.getElementById("report-plate-end").value = today;
        document.getElementById("report-firm-start").value = startStr;
        document.getElementById("report-firm-end").value = today;
        document.getElementById("report-date-start").value = startStr;
        document.getElementById("report-date-end").value = today;
    }

    async function fetchPlateReport() {
        const plaka = normalizePlateInput(document.getElementById("report-plate-input").value);
        const baslangic = document.getElementById("report-plate-start").value;
        const bitis = document.getElementById("report-plate-end").value;
        const grup = document.getElementById("report-plate-group").value;
        const note = document.getElementById("report-plate-note");
        note.textContent = "";

        if (!plaka) return (note.textContent = "Plaka gerekli");

        const data = await fetchJson(`${API_BASE}/rapor/plaka?plaka=${plaka}&baslangic=${baslangic}&bitis=${bitis}&grup=${grup}&kullanici_id=${currentUser.id}`);
        document.getElementById("report-plate-body").innerHTML = data.liste.map(r => `
            <tr>
                <td>${r.tarih}</td>
                <td>${r.plaka}</td>
                <td>${r.firma_adi || '-'}</td>
                <td>${formatCurrency(r.satis_miktari)}</td>
                <td>${formatCurrency(r.hakedis)}</td>
            </tr>
        `).join("");

        const ctx = document.getElementById("plateChart").getContext("2d");
        plateChart = destroyChart(plateChart);
        plateChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: data.grafik.map(d => d.period),
                datasets: [
                    {
                        label: "Satış",
                        data: data.grafik.map(d => d.toplam_satis),
                        borderColor: "#3b82f6",
                        backgroundColor: "rgba(59,130,246,0.15)",
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: "Hak ediş",
                        data: data.grafik.map(d => d.toplam_hakedis),
                        borderColor: "#ec4899",
                        backgroundColor: "rgba(236,72,153,0.15)",
                        fill: true,
                        tension: 0.3
                    }
                ]
            }
        });
    }

    async function fetchFirmReport() {
        const firma = normalizeFirmInput(document.getElementById("report-firm-input").value);
        const baslangic = document.getElementById("report-firm-start").value;
        const bitis = document.getElementById("report-firm-end").value;
        const grup = document.getElementById("report-firm-group").value;
        const note = document.getElementById("report-firm-note");
        note.textContent = "";

        if (!firma) return (note.textContent = "Firma adı gerekli");

        const data = await fetchJson(`${API_BASE}/rapor/firma?firma=${firma}&baslangic=${baslangic}&bitis=${bitis}&grup=${grup}&kullanici_id=${currentUser.id}`);
        document.getElementById("report-firm-body").innerHTML = data.liste.map(r => `
            <tr>
                <td>${r.tarih}</td>
                <td>${formatCurrency(r.toplam_satis)}</td>
                <td>${formatCurrency(r.toplam_hakedis)}</td>
            </tr>
        `).join("");

        const ctx = document.getElementById("firmChart").getContext("2d");
        firmChart = destroyChart(firmChart);
        firmChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: data.grafik.map(d => d.period),
                datasets: [
                    {
                        label: "Satış",
                        data: data.grafik.map(d => d.toplam_satis),
                        backgroundColor: "rgba(59,130,246,0.6)"
                    },
                    {
                        label: "Hak ediş",
                        data: data.grafik.map(d => d.toplam_hakedis),
                        backgroundColor: "rgba(236,72,153,0.6)"
                    }
                ]
            }
        });
    }

    async function fetchDateReport() {
        const baslangic = document.getElementById("report-date-start").value;
        const bitis = document.getElementById("report-date-end").value;
        const note = document.getElementById("report-date-note");
        note.textContent = "";

        const data = await fetchJson(`${API_BASE}/rapor/tarih?baslangic=${baslangic}&bitis=${bitis}&kullanici_id=${currentUser.id}`);
        document.getElementById("report-date-net").textContent = formatCurrency(data.net_ciro);

        document.getElementById("report-date-firm-body").innerHTML = data.firmalar.map(r => `
            <tr><td>${r.firma || '-'}</td><td>${formatCurrency(r.net_ciro)}</td></tr>
        `).join("");

        document.getElementById("report-date-year-body").innerHTML = data.yillik.map(r => `
            <tr><td>${r.period}</td><td>${formatCurrency(r.net_ciro)}</td></tr>
        `).join("");

        const pieCtx = document.getElementById("datePieChart").getContext("2d");
        datePieChart = destroyChart(datePieChart);
        datePieChart = new Chart(pieCtx, {
            type: "pie",
            data: {
                labels: data.firmalar.map(d => d.firma || "Bireysel"),
                datasets: [{
                    data: data.firmalar.map(d => d.net_ciro),
                    backgroundColor: ["#3b82f6", "#ec4899", "#10b981", "#f59e0b", "#6366f1", "#14b8a6"]
                }]
            }
        });

        const barCtx = document.getElementById("dateBarChart").getContext("2d");
        dateBarChart = destroyChart(dateBarChart);
        dateBarChart = new Chart(barCtx, {
            type: "bar",
            data: {
                labels: data.aylik.map(d => d.period),
                datasets: [{
                    label: "Aylık Net Ciro",
                    data: data.aylik.map(d => d.net_ciro),
                    backgroundColor: "rgba(59,130,246,0.7)"
                }]
            }
        });
    }

    document.getElementById("report-plate-btn").onclick = fetchPlateReport;
    document.getElementById("report-firm-btn").onclick = fetchFirmReport;
    document.getElementById("report-date-btn").onclick = fetchDateReport;

    //ana sayfa ve bölüm geçişleri
    function switchSection(sectionKey) {
        document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
        document.getElementById("section-" + sectionKey).classList.remove("hidden");

        const isHome = sectionKey === "home";
        appShell.classList.toggle("home-only", isHome);

        document.querySelectorAll(".menu-btn").forEach(b => b.classList.remove("active"));
        if (!isHome) {
            const activeBtn = document.querySelector(`.menu-btn[data-section="${sectionKey}"]`);
            if (activeBtn) activeBtn.classList.add("active");
        }

        document.querySelectorAll(".nav-card").forEach(c => c.classList.remove("active"));
        const activeCard = document.querySelector(`.nav-card[data-section="${sectionKey}"]`);
        if (activeCard) activeCard.classList.add("active");

        if (sectionKey === "search") showReportTab("plate");
    }

    document.querySelectorAll(".menu-btn, .nav-card").forEach(btn => {
        btn.onclick = () => { switchSection(btn.dataset.section); };
    });
</script>
</body>
</html>
